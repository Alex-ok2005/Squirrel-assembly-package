# Порядок сборки приложения Zabota.Chat

1. [Порядок сборки приложения](#ref)
2. [Порядок сборки дистрибутива для первоначальной установки приложения](#ref1)
3. [Порядок сборки дистрибутива для последующего автоматического обновления приложения](#ref2)


<a name="ref"></a>
## Порядок сборки приложения

* После клонирования репозитория откройте решение в *Visual Studio*, установите конфигурацию *Releas*, *AnyCPU* и выполните комманду **Пересобрать решение**.
* Иногда требуется удалить все пакеты CEFSharp и заново установить их из Nuget Gallery .
* Дистрибутив будет создан в папке *\\ZabotaChat\ZabotaChat\bin\Release*, откройте в Проводнике эту папку.
* Удалите все файлы с расширением *pdb* и *xml*.
* Переименуйте файл *CefSharp.BrowserSubprocess.exe* в *CefSharp.BrowserSubprocess.ex_*.
* Из папки *locales* удалите все файлы кроме *en-US.pak* и *ru.pak*.

В зависимости от того, нужен ли дистрибутив для начальной установки приложения или пакет для автоматического обновления, порядок дальнейших действий будет отличаться. 

<a name="ref1"></a>
## Порядок сборки дистрибутива для первоначальной установки приложения

* Переместите файл *z20.ini* из папки *\\ZabotaChat\ZabotaChat\bin\Release* в папку *\\ZabotaChat\ZabotaChat\bin*.
* Запустите утилиту *NuGet Package Explorer* и создайте с помощью комманды **Create a new package** новый файл спецификации пакета.
* В правой панели *Package Metadata* с помощью соответствующей кнопки выберете режим **Edit Metadata**, заполните поля следующим образом:
	![NuGet Package Explorer](images/img1.png)
* В поле *Version* внесите текущую версию сбороки. Обратите внимание, номер версии должен соответствовать требованиям [SemVer](https://semver.org/lang/ru/), т.е. номер должен быть закодирован 3-мя числами через разделитель ".". В ином случае при компиляции пакета будет выдана ошибка.
* Сохраните метаданные нажатием зеленой галочки в верхней части панели.
* Далее в правой панели *Package Content* создайте следующую структуру каталогов и перенесите в них файлы из дистрибутива.
	![NuGet Package Explorer](images/img2.png)
* Более детально процесс создания файла спецификации пакета рассмотрен [здесь](https://github.com/NuGetPackageExplorer/NuGetPackageExplorer).
* Сохраните файл спецификации: **File -> Save as -> ZabotaChat.1.0.0.nupkg**.
	![Save as](images/img3.png)
* Закройте файл спецификации: **File -> Close**.
* В *Visual Studio* выбором комманды **Вид -> Другие окна -> Консоль диспетчера пакетов** запустите *Package Manager*. 
* Для компяляции пакета в консоли *Package Manager* введите следующую комманду: 
	**Squirrel --no-msi --releasify ZabotaChat.1.0.0.nupkg**
Возможно требуется указать полный путь до файла спецификации *.nupkg*.
* В процессе компиляции будет создана папка *Releases* со следующими файлами:
1. RELEASES - хеш-суммы пакетов обновления
2. Setup.exe - инсталятор
3. ZabotaChat-1.0.0-full.nupkg - непосредственно сам пакет с библиотеками и исполняемыми файлами.

* Обратите внимание, при запуске *Setup.exe* Squirrel не предлагает выбор пути установки приложения, а по умолчанию устанавливает его в папку *\\Users\CurrentUser\AppData\Local\ZabotaChat*. Таким образом, если на целевой машине рабочий каталог приложения будет выбран другим, необходимо передавать конечному пользователю не скомпилированный пакет, а архив. Создайте архив *ZabotaChat.zip* из папки с уже устновленным пакетом: *\\Users\CurrentUser\AppData\Local\ZabotaChat*.

	![Package content](images/img4.png)
* После создания архива, установленное в системе приложение *ZabotaChat* можно удалить с помощью системной утилиты *Панель управления -> Программы и компоненты -> Удалить*.  

<a name="ref2"></a>
## Порядок сборки дистрибутива для последующего автоматического обновления приложения

* Удалите файлы *current.ini* и *z20.ini* из папки *\\ZabotaChat\ZabotaChat\bin\Release*.
* Запустите утилиту *NuGet Package Explorer* и откройте последнюю созданную спецификацию с помощью комманды **Open a local package**.
* В правой панели *Package Metadata* нажмите кнопку **Edit Metadata** и измените поле *Version* на новую, более старшую версию сборки, например *1.1.0*.
* Обратите внимание, номер версии должен соответствовать требованиям [SemVer](https://semver.org/lang/ru/), т.е. номер должен быть закодирован 3-мя числами через разделитель ".". В ином случае при компиляции пакета будет выдана ошибка.
* Сохраните метаданные нажатием зеленой галочки в верхней части панели.
* Далее, в правой панели *Package Content* раскройте необходимые папки и перенесите в них файлы из дистрибутива. Можно обновлять только те файлы, которые были изменены.
* Сохраните новую версию файла спецификации **File -> Save as -> ZabotaChat.1.1.0.nupkg**. Не используйте комманду **File -> Save**, т.к. в этом случае новый файл спецификации будет перезаписан поверх файла предыдущей версии *ZabotaChat.1.0.0.nupkg* со старым номером версии.
* Закройте файл спецификации **File -> Close**.
* В *Visual Studio* запустите *Package Manager* выбором комманды **Вид -> Другие окна -> Консоль диспетчера пакетов**.
* Для компяляции пакета в консоли *Package Manager* введите комманду: **Squirrel --no-msi --releasify ZabotaChat.1.1.0.nupkg**, указав последний созданный файл спецификации. Возможно потребуется указать полный путь до файла спецификации *.nupkg*.
* В процессе компиляции в папке *Releases* будут изменены и добавлены следующие файлы:
1. RELEASES - перечень хэш-сумм пакетов обновления, будет обновлен, в него будет добавлена хеш-сумма нового пакета обновления
2. Setup.exe - инсталятор, будет обновлен
3. ZabotaChat-1.1.0-full.nupkg - новый файл, содержащий полный пакет обновления с библиотеками и исполняемыми файлами
4. ZabotaChat-1.1.0-delta.nupkg - новый файл - пакет содержащий разницу между текущей и предыдущей версией.

	![Package content](images/img5.png)
* Файл пакета предыдущей версии *ZabotaChat-1.0.0-full.nupkg* останется неизмененным.
* Файл *Setup.exe* не нужен, его можно удалить.
* Далее, на сервер обновления загружаются следующие файлы (пример):
1. RELEASES
2. ZabotaChat-1.1.0-full.nupkg 
3. ZabotaChat-1.1.0-delta.nupkg
